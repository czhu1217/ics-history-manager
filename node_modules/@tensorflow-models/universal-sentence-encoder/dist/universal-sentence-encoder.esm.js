/**
    * @license
    * Copyright 2019 Google LLC. All Rights Reserved.
    * Licensed under the Apache License, Version 2.0 (the "License");
    * you may not use this file except in compliance with the License.
    * You may obtain a copy of the License at
    *
    * http://www.apache.org/licenses/LICENSE-2.0
    *
    * Unless required by applicable law or agreed to in writing, software
    * distributed under the License is distributed on an "AS IS" BASIS,
    * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    * See the License for the specific language governing permissions and
    * limitations under the License.
    * =============================================================================
    */
import{loadGraphModel}from"@tensorflow/tfjs-converter";import{util,tensor2d,tensor1d}from"@tensorflow/tfjs-core";function __awaiter(e,r,n,t){return new(n||(n=Promise))(function(o,i){function a(e){try{c(t.next(e))}catch(e){i(e)}}function u(e){try{c(t.throw(e))}catch(e){i(e)}}function c(e){e.done?o(e.value):new n(function(r){r(e.value)}).then(a,u)}c((t=t.apply(e,r||[])).next())})}function __generator(e,r){var n,t,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function u(i){return function(u){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,t&&(o=2&i[0]?t.return:i[0]?t.throw||((o=t.return)&&o.call(t),0):t.next)&&!(o=o.call(t,i[1])).done)return o;switch(t=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,t=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!(o=(o=a.trys).length>0&&o[o.length-1])&&(6===i[0]||2===i[0])){a=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){a.label=i[1];break}if(6===i[0]&&a.label<o[1]){a.label=o[1],o=i;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(i);break}o[2]&&a.ops.pop(),a.trys.pop();continue}i=r.call(e,a)}catch(e){i=[6,e],t=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,u])}}}var stringToChars=function(e){for(var r=[],n=0,t=e;n<t.length;n++){var o=t[n];r.push(o)}return r},TrieNode=function(){return function(){this.parent=null,this.children={},this.end=!1,this.word=[[],0,0]}}(),Trie=function(){function e(){this.root=new TrieNode}return e.prototype.insert=function(e,r,n){for(var t=this.root,o=stringToChars(e),i=0;i<o.length;i++)t.children[o[i]]||(t.children[o[i]]=new TrieNode,t.children[o[i]].parent=t,t.children[o[i]].word[0]=t.word[0].concat(o[i])),t=t.children[o[i]],i===o.length-1&&(t.end=!0,t.word[1]=r,t.word[2]=n)},e.prototype.commonPrefixSearch=function(e){for(var r=[],n=this.root.children[e[0]],t=0;t<e.length&&n;t++)n.end&&r.push(n.word),n=n.children[e[t+1]];return r.length||r.push([[e[0]],0,0]),r},e}(),separator="â–";function processInput(e){var r=e.normalize("NFKC");return separator+r.replace(/ /g,separator)}var RESERVED_SYMBOLS_COUNT=6,Tokenizer=function(){function e(e){this.vocabulary=e,this.trie=new Trie;for(var r=RESERVED_SYMBOLS_COUNT;r<this.vocabulary.length;r++)this.trie.insert(this.vocabulary[r][0],this.vocabulary[r][1],r)}return e.prototype.encode=function(e){var r=[],n=[],t=[];e=processInput(e);for(var o=stringToChars(e),i=0;i<=o.length;i++)r.push({}),n.push(0),t.push(0);for(i=0;i<o.length;i++)for(var a=this.trie.commonPrefixSearch(o.slice(i)),u=0;u<a.length;u++){var c=a[u],s={key:c[0],score:c[1],index:c[2]};null==r[i+(l=c[0].length)][i]&&(r[i+l][i]=[]),r[i+l][i].push(s)}for(var l=0;l<=o.length;l++)for(var h in r[l]){var f=r[l][h];for(u=0;u<f.length;u++){var d=f[u],p=d.score+t[l-d.key.length];(0===t[l]||p>=t[l])&&(t[l]=p,n[l]=f[u].index)}}for(var v=[],_=n.length-1;_>0;)v.push(n[_]),_-=this.vocabulary[n[_]][0].length;var g=[],w=!1;for(i=0;i<v.length;i++){var y=v[i];w&&0===y||g.push(y),w=0===y}return g.reverse()},e}(),BASE_PATH="https://storage.googleapis.com/tfjs-models/savedmodel/universal_sentence_encoder/";function load(){return __awaiter(this,void 0,void 0,function(){var e;return __generator(this,function(r){switch(r.label){case 0:return[4,(e=new UniversalSentenceEncoder).load()];case 1:return r.sent(),[2,e]}})})}function loadTokenizer(e){return __awaiter(this,void 0,void 0,function(){var r;return __generator(this,function(n){switch(n.label){case 0:return[4,loadVocabulary(e)];case 1:return r=n.sent(),[2,new Tokenizer(r)]}})})}function loadVocabulary(e){return void 0===e&&(e=BASE_PATH+"vocab.json"),__awaiter(this,void 0,void 0,function(){return __generator(this,function(r){switch(r.label){case 0:return[4,util.fetch(e)];case 1:return[2,r.sent().json()]}})})}var UniversalSentenceEncoder=function(){function e(){}return e.prototype.loadModel=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){return[2,loadGraphModel(BASE_PATH+"model.json")]})})},e.prototype.load=function(){return __awaiter(this,void 0,void 0,function(){var e,r,n;return __generator(this,function(t){switch(t.label){case 0:return[4,Promise.all([this.loadModel(),loadVocabulary()])];case 1:return e=t.sent(),r=e[0],n=e[1],this.model=r,this.tokenizer=new Tokenizer(n),[2]}})})},e.prototype.embed=function(e){return __awaiter(this,void 0,void 0,function(){var r,n,t,o,i,a,u,c=this;return __generator(this,function(s){switch(s.label){case 0:for("string"==typeof e&&(e=[e]),r=e.map(function(e){return c.tokenizer.encode(e)}),n=r.map(function(e,r){return e.map(function(e,n){return[r,n]})}),t=[],o=0;o<n.length;o++)t=t.concat(n[o]);return i=tensor2d(t,[t.length,2],"int32"),a=tensor1d(util.flatten(r),"int32"),[4,this.model.executeAsync({indices:i,values:a})];case 1:return u=s.sent(),i.dispose(),a.dispose(),[2,u]}})})},e}();export{Tokenizer,UniversalSentenceEncoder,load,loadTokenizer};
